@page "/support-tickets"
@rendermode InteractiveServer
@using FabrikamContracts.DTOs.Support
@using FabrikamDashboard.Services
@inject FabrikamApiClient ApiClient
@inject DashboardStateService StateService
@inject ILogger<SupportTickets> Logger

<PageTitle>Support Tickets - Fabrikam Dashboard</PageTitle>

<div class="tickets-container">
    <div class="tickets-header">
        <h1 class="tickets-title">üé´ Support Tickets</h1>
        <div class="tickets-filters">
            <div class="timeframe-selector">
                <label for="timeframe">üìÖ Timeframe:</label>
                <select id="timeframe" class="filter-select" @bind="_selectedTimeframe" @bind:after="OnTimeframeChanged">
                    <option value="7days">Last 7 Days</option>
                    <option value="30days">Last 30 Days</option>
                    <option value="90days">Last 90 Days</option>
                    <option value="365days">Last Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <select class="filter-select" @onchange="FilterByStatus">
                <option value="">All Statuses</option>
                <option value="Open">Open</option>
                <option value="InProgress">In Progress</option>
                <option value="Resolved">Resolved</option>
                <option value="Closed">Closed</option>
            </select>
            <select class="filter-select" @onchange="FilterByPriority">
                <option value="">All Priorities</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
            <button class="refresh-button" @onclick="LoadTickets">üîÑ Refresh</button>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner">‚è≥</div>
            <p>Loading support tickets...</p>
        </div>
    }
    else if (_hasError)
    {
        <div class="error-container">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3>Unable to Load Tickets</h3>
            <p>@_errorMessage</p>
            <button class="retry-button" @onclick="LoadTickets">Try Again</button>
        </div>
    }
    else if (_filteredTickets.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">‚úÖ</div>
            <h3>No Tickets Found</h3>
            <p>@(_selectedStatus != "" || _selectedPriority != "" ? "Try adjusting your filters" : "All caught up! No support tickets at the moment.")</p>
        </div>
    }
    else
    {
        <div class="tickets-stats">
            <div class="stat-card stat-open">
                <div class="stat-value">@_tickets.Count(t => t.Status == "Open")</div>
                <div class="stat-label">Open</div>
            </div>
            <div class="stat-card stat-inprogress">
                <div class="stat-value">@_tickets.Count(t => t.Status == "InProgress")</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card stat-resolved">
                <div class="stat-value">@_tickets.Count(t => t.Status == "Resolved")</div>
                <div class="stat-label">Resolved</div>
            </div>
            <div class="stat-card stat-closed">
                <div class="stat-value">@_tickets.Count(t => t.Status == "Closed")</div>
                <div class="stat-label">Closed</div>
            </div>
        </div>

        <div class="tickets-table">
            <table>
                <thead>
                    <tr>
                        <th>Ticket #</th>
                        <th>Customer</th>
                        <th>Category</th>
                        <th>Subject</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ticket in _filteredTickets.OrderByDescending(t => t.CreatedDate))
                    {
                        <tr class="ticket-row @GetPriorityClass(ticket.Priority)">
                            <td class="ticket-id">
                                <span class="ticket-number">TKT-@ticket.Id.ToString("D4")</span>
                            </td>
                            <td>
                                <div class="customer-info">
                                    <div class="customer-name">@ticket.Customer.Name</div>
                                    @if (!string.IsNullOrEmpty(ticket.Customer.Region))
                                    {
                                        <div class="order-reference">Region: @ticket.Customer.Region</div>
                                    }
                                </div>
                            </td>
                            <td>
                                <span class="category-badge category-@ticket.Category.ToLower()">
                                    @GetCategoryIcon(ticket.Category) @ticket.Category
                                </span>
                            </td>
                            <td class="ticket-subject">@ticket.Subject</td>
                            <td>
                                <span class="priority-badge priority-@ticket.Priority.ToLower()">
                                    @ticket.Priority
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-@ticket.Status.ToLower()">
                                    @ticket.Status
                                </span>
                            </td>
                            <td class="ticket-date">@ticket.CreatedDate.ToString("MMM d, yyyy")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="tickets-summary">
            Showing @_filteredTickets.Count of @_tickets.Count tickets
        </div>
    }
</div>

@code {
    private List<SupportTicketListItemDto> _tickets = new();
    private List<SupportTicketListItemDto> _filteredTickets = new();
    private bool _isLoading = true;
    private bool _hasError = false;
    private string _errorMessage = "";
    private string _selectedStatus = "";
    private string _selectedPriority = "";
    private string _selectedTimeframe = "365days"; // Default

    protected override async Task OnInitializedAsync()
    {
        // Use the timeframe from state service (persists across pages)
        _selectedTimeframe = StateService.CurrentTimeframe;
        await LoadTickets();
    }

    private async Task LoadTickets()
    {
        _isLoading = true;
        _hasError = false;
        
        try
        {
            var (fromDate, toDate) = GetDateRange(_selectedTimeframe);
            _tickets = await ApiClient.GetSupportTicketsAsync(fromDate, toDate);
            ApplyFilters();
            Logger.LogInformation("Loaded {Count} support tickets", _tickets.Count);
        }
        catch (Exception ex)
        {
            _hasError = true;
            _errorMessage = "Failed to load support tickets. Please try again.";
            Logger.LogError(ex, "Error loading support tickets");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterByStatus(ChangeEventArgs e)
    {
        _selectedStatus = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void FilterByPriority(ChangeEventArgs e)
    {
        _selectedPriority = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        _filteredTickets = _tickets
            .Where(t => string.IsNullOrEmpty(_selectedStatus) || t.Status == _selectedStatus)
            .Where(t => string.IsNullOrEmpty(_selectedPriority) || t.Priority == _selectedPriority)
            .ToList();
    }

    private string GetPriorityClass(string priority)
    {
        return priority.ToLower() switch
        {
            "critical" => "priority-critical-row",
            "high" => "priority-high-row",
            _ => ""
        };
    }

    private string GetCategoryIcon(string category)
    {
        return category switch
        {
            "OrderInquiry" => "üì¶",
            "DeliveryIssue" => "üöö",
            "ProductDefect" => "‚ö†Ô∏è",
            "Installation" => "üîß",
            "Billing" => "üí∞",
            "Technical" => "üîå",
            "Complaint" => "üò†",
            _ => "üìã"
        };
    }

    private async Task OnTimeframeChanged()
    {
        // Update the state service (persists across pages)
        StateService.UpdateTimeframe(_selectedTimeframe);
        
        // Reload tickets with new timeframe
        await LoadTickets();
    }

    private static (DateTime? fromDate, DateTime? toDate) GetDateRange(string? timeframe)
    {
        if (string.IsNullOrEmpty(timeframe) || timeframe == "all")
        {
            return (null, null); // No filtering
        }

        var toDate = DateTime.UtcNow;
        var fromDate = timeframe.ToLower() switch
        {
            "7days" or "week" => toDate.AddDays(-7),
            "30days" or "month" => toDate.AddDays(-30),
            "90days" or "quarter" => toDate.AddDays(-90),
            "365days" or "year" => toDate.AddDays(-365),
            _ => toDate.AddDays(-365) // Default to year
        };

        return (fromDate, toDate);
    }
}
