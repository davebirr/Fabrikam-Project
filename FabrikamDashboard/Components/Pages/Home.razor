@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using FabrikamDashboard.Services
@inject NavigationManager Navigation
@inject SimulatorClient SimulatorClient
@inject ILogger<Home> Logger
@inject DashboardStateService StateService
@implements IAsyncDisposable

<PageTitle>Fabrikam Dashboard</PageTitle>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">🏭 Fabrikam Modular Homes - Live Dashboard</h1>
        <div class="dashboard-controls">
            <div class="timeframe-selector">
                <label for="timeframe">📅 Timeframe:</label>
                <select id="timeframe" @bind="_selectedTimeframe" @bind:after="OnTimeframeChanged">
                    <option value="7days">Last 7 Days</option>
                    <option value="30days">Last 30 Days</option>
                    <option value="90days">Last 90 Days</option>
                    <option value="365days">Last Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>
        </div>
        <div class="dashboard-status">
            @if (_isConnected)
            {
                <span class="status-connected">🟢 Live</span>
            }
            else if (_isReconnecting)
            {
                <span class="status-reconnecting">🟡 Reconnecting...</span>
            }
            else
            {
                <span class="status-disconnected">🔴 Disconnected</span>
            }
            
            @if (_hasData)
            {
                <span class="last-update">📊 Updated: @_lastUpdate.ToString("HH:mm:ss")</span>
            }
            else if (_isLoading)
            {
                <span class="last-update loading-pulse">⏳ Loading data... (@((int)(DateTime.UtcNow - _loadingStartTime).TotalSeconds) seconds)</span>
            }
            else if (_hasError)
            {
                <span class="last-update error">⚠️ Error loading data</span>
            }
            else
            {
                <span class="last-update">⏳ Waiting for data...</span>
            }
            
            <button class="refresh-button" @onclick="RequestManualRefresh" disabled="@(!_isConnected)">
                🔄 Refresh
            </button>
        </div>
    </div>

    @if (_dashboardData != null)
    {
        <!-- Metric Cards -->
        <div class="metrics-grid">
            <MetricCard Title="Active Orders" 
                        Value="@_dashboardData.TotalOrders.ToString()" 
                        Icon="📦" 
                        Color="blue"
                        OnClick="NavigateToOrders" />
            <MetricCard Title="Open Tickets" 
                        Value="@_dashboardData.OpenTickets.ToString()" 
                        Icon="🎫" 
                        Color="orange"
                        OnClick="NavigateToSupportTickets" />
            <MetricCard Title="Total Revenue" 
                        Value="@($"${_dashboardData.TotalRevenue:N0}")" 
                        Icon="💰" 
                        Color="green" />
            <MetricCard Title="Avg Order Value" 
                        Value="@($"${_dashboardData.AverageOrderValue:N0}")" 
                        Icon="📊" 
                        Color="purple" />
        </div>

        <!-- Charts Section -->
        <div class="charts-row">
            <div class="chart-card">
                <h3>Orders by Status</h3>
                <div class="status-chart">
                    @foreach (var status in _dashboardData.OrdersByStatus.OrderByDescending(x => x.Value))
                    {
                        var percentage = _dashboardData.TotalOrders > 0 
                            ? (status.Value * 100.0 / _dashboardData.TotalOrders) 
                            : 0;
                        <div class="status-bar">
                            <div class="status-label">
                                <span class="status-badge status-@status.Key.ToLower()">@status.Key</span>
                                <span class="status-count">@status.Value orders</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill status-@status.Key.ToLower()" 
                                     style="width: @percentage%"></div>
                            </div>
                            <span class="status-percentage">@percentage.ToString("F1")%</span>
                        </div>
                    }
                </div>
            </div>

            <div class="chart-card">
                <h3>Orders by Region</h3>
                <div class="status-chart">
                    @foreach (var region in _dashboardData.OrdersByRegion.OrderByDescending(x => x.Value))
                    {
                        var percentage = _dashboardData.TotalOrders > 0 
                            ? (region.Value * 100.0 / _dashboardData.TotalOrders) 
                            : 0;
                        <div class="status-bar">
                            <div class="status-label">
                                <span class="region-badge">@GetRegionIcon(region.Key) @region.Key</span>
                                <span class="status-count">@region.Value orders</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill region-bar" 
                                     style="width: @percentage%"></div>
                            </div>
                            <span class="status-percentage">@percentage.ToString("F1")%</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Simulator Controls -->
        @if (_dashboardData.SimulatorStatus != null)
        {
            <div class="simulator-section">
                <h2>🎲 Simulator Controls</h2>
                <p class="simulator-description">
                    Control the FabrikamSimulator background workers to generate realistic business activity.
                </p>
                <div class="simulator-controls">
                    <SimulatorToggle Name="Order Progression" 
                                     Enabled="@_dashboardData.SimulatorStatus.OrderProgression.Enabled"
                                     LastRun="@_dashboardData.SimulatorStatus.OrderProgression.LastRun"
                                     NextRun="@_dashboardData.SimulatorStatus.OrderProgression.NextRun"
                                     OnToggle="@(() => ToggleSimulator("orders/progression", !_dashboardData.SimulatorStatus.OrderProgression.Enabled))" />
                    
                    <SimulatorToggle Name="Order Generator" 
                                     Enabled="@_dashboardData.SimulatorStatus.OrderGenerator.Enabled"
                                     LastRun="@_dashboardData.SimulatorStatus.OrderGenerator.LastRun"
                                     NextRun="@_dashboardData.SimulatorStatus.OrderGenerator.NextRun"
                                     OnToggle="@(() => ToggleSimulator("orders/generator", !_dashboardData.SimulatorStatus.OrderGenerator.Enabled))" />
                    
                    <SimulatorToggle Name="Ticket Generator" 
                                     Enabled="@_dashboardData.SimulatorStatus.TicketGenerator.Enabled"
                                     LastRun="@_dashboardData.SimulatorStatus.TicketGenerator.LastRun"
                                     NextRun="@_dashboardData.SimulatorStatus.TicketGenerator.NextRun"
                                     OnToggle="@(() => ToggleSimulator("tickets", !_dashboardData.SimulatorStatus.TicketGenerator.Enabled))" />
                </div>
            </div>
        }
        else
        {
            <div class="simulator-section">
                <h2>🎲 Simulator Status</h2>
                <div class="info-message">
                    ⚠️ FabrikamSimulator is not running. Start the simulator to enable worker controls.
                </div>
            </div>
        }
    }
    else
    {
        <div class="loading-container">
            <div class="loading-spinner">⏳</div>
            <p>Loading dashboard data...</p>
        </div>
    }
</div>

@code {
    private HubConnection? _hubConnection;
    private DashboardDataDto? _dashboardData;
    private bool _isConnected;
    private bool _isReconnecting;
    private bool _isLoading = true;
    private bool _hasData;
    private bool _hasError;
    private DateTime _lastUpdate = DateTime.UtcNow;
    private int _consecutiveErrors = 0;
    private const int MaxConsecutiveErrors = 3;
    private DateTime _loadingStartTime = DateTime.UtcNow;
    private string _selectedTimeframe = "365days"; // Default to year to match MCP tool

    protected override async Task OnInitializedAsync()
    {
        _loadingStartTime = DateTime.UtcNow;

        // Subscribe to state service changes
        StateService.OnDataChanged += HandleDataChanged;
        
        // Get current timeframe from state service
        _selectedTimeframe = StateService.CurrentTimeframe;
        
        // Get initial data if available
        var initialData = StateService.CurrentData;
        if (initialData != null && (initialData.TotalOrders > 0 || initialData.OpenTickets > 0 || initialData.TotalRevenue > 0))
        {
            _dashboardData = initialData;
            _hasData = true;
            _isLoading = false;
            _isConnected = true;
            _lastUpdate = initialData.Timestamp;
            Logger.LogInformation("✅ Loaded initial dashboard data: {Orders} orders, {Tickets} tickets, ${Revenue} revenue",
                initialData.TotalOrders, initialData.OpenTickets, initialData.TotalRevenue);
        }
        else
        {
            Logger.LogInformation("⏳ Waiting for dashboard data from background service...");
            _isConnected = true; // We're always "connected" to the state service
        }

        await Task.CompletedTask;
    }

    private void HandleDataChanged()
    {
        var data = StateService.CurrentData;
        
        if (data != null && (data.TotalOrders > 0 || data.OpenTickets > 0 || data.TotalRevenue > 0))
        {
            _dashboardData = data;
            _lastUpdate = data.Timestamp;
            _hasData = true;
            _hasError = false;
            _isLoading = false;
            _consecutiveErrors = 0;

            Logger.LogInformation("✅ Received dashboard update: {Orders} orders, {Tickets} tickets, ${Revenue} revenue",
                data.TotalOrders, data.OpenTickets, data.TotalRevenue);

            // Trigger UI update on Blazor's synchronization context
            InvokeAsync(StateHasChanged);
        }
        else if (data != null)
        {
            _consecutiveErrors++;
            if (_consecutiveErrors >= MaxConsecutiveErrors && !_hasData)
            {
                _hasError = true;
                _isLoading = false;
                Logger.LogWarning("❌ Received {Count} consecutive empty data updates", _consecutiveErrors);
                InvokeAsync(StateHasChanged);
            }
        }
    }

    private void OnTimeframeChanged()
    {
        // Update the state service with new timeframe
        StateService.UpdateTimeframe(_selectedTimeframe);
        
        // Trigger immediate refresh with new timeframe
        _isLoading = true;
        _hasError = false;
        
        Logger.LogInformation("Timeframe changed to: {Timeframe}", _selectedTimeframe);
    }

    private async Task RequestManualRefresh()
    {
        if (_hubConnection == null || !_isConnected)
        {
            Logger.LogWarning("Cannot refresh - not connected to hub");
            return;
        }

        try
        {
            _isLoading = true;
            _hasError = false;
            await InvokeAsync(StateHasChanged);
            
            // Send refresh request to server (server will broadcast updated data)
            await _hubConnection.SendAsync("RequestRefresh");
            Logger.LogInformation("Manual refresh requested");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error requesting manual refresh");
            _hasError = true;
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ToggleSimulator(string endpoint, bool enable)
    {
        try
        {
            var success = await SimulatorClient.ToggleWorkerAsync(endpoint, enable);
            if (success)
            {
                Logger.LogInformation("Toggled {Endpoint} to {State}", endpoint, enable ? "ON" : "OFF");
                
                // Wait a moment for the simulator to update its state
                await Task.Delay(1000);
                
                // Fetch fresh simulator status immediately to update UI
                var newStatus = await SimulatorClient.GetStatusAsync();
                if (newStatus != null && _dashboardData != null)
                {
                    // Update the dashboard data with new simulator status
                    _dashboardData.SimulatorStatus = newStatus;
                    await InvokeAsync(StateHasChanged);
                }
            }
            else
            {
                Logger.LogWarning("Failed to toggle {Endpoint}", endpoint);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling simulator worker");
        }
    }

    private string GetRegionIcon(string region)
    {
        return region switch
        {
            "Northeast" => "🏔️",
            "Southeast" => "🌴",
            "Midwest" => "🌾",
            "Southwest" => "🌵",
            "West" => "🏖️",
            _ => "📍"
        };
    }

    private void NavigateToOrders()
    {
        Navigation.NavigateTo("/orders");
    }

    private void NavigateToSupportTickets()
    {
        Navigation.NavigateTo("/support-tickets");
    }

    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from state service
        StateService.OnDataChanged -= HandleDataChanged;
        
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
