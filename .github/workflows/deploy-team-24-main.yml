name: Deploy Team-24 (Main Branch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  TEAM_NUMBER: '24'
  RESOURCE_GROUP: 'rg-fabrikam-team-24'

jobs:
  # Build all projects once (parallel)
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [api, mcp, sim, dash]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies for ${{ matrix.project }}
        run: |
          if [ "${{ matrix.project }}" == "api" ]; then
            dotnet restore FabrikamApi/src/FabrikamApi.csproj
          elif [ "${{ matrix.project }}" == "mcp" ]; then
            dotnet restore FabrikamMcp/src/FabrikamMcp.csproj
          elif [ "${{ matrix.project }}" == "sim" ]; then
            dotnet restore FabrikamSimulator/src/FabrikamSimulator.csproj
          elif [ "${{ matrix.project }}" == "dash" ]; then
            dotnet restore FabrikamDashboard/FabrikamDashboard.csproj
          fi
      
      - name: Build ${{ matrix.project }}
        run: |
          if [ "${{ matrix.project }}" == "api" ]; then
            dotnet build FabrikamApi/src/FabrikamApi.csproj --configuration Release --no-restore
          elif [ "${{ matrix.project }}" == "mcp" ]; then
            dotnet build FabrikamMcp/src/FabrikamMcp.csproj --configuration Release --no-restore
          elif [ "${{ matrix.project }}" == "sim" ]; then
            dotnet build FabrikamSimulator/src/FabrikamSimulator.csproj --configuration Release --no-restore
          elif [ "${{ matrix.project }}" == "dash" ]; then
            dotnet build FabrikamDashboard/FabrikamDashboard.csproj --configuration Release --no-restore
          fi
      
      - name: Publish ${{ matrix.project }}
        run: |
          if [ "${{ matrix.project }}" == "api" ]; then
            dotnet publish FabrikamApi/src/FabrikamApi.csproj -c Release -o ./publish
          elif [ "${{ matrix.project }}" == "mcp" ]; then
            dotnet publish FabrikamMcp/src/FabrikamMcp.csproj -c Release -o ./publish
          elif [ "${{ matrix.project }}" == "sim" ]; then
            dotnet publish FabrikamSimulator/src/FabrikamSimulator.csproj -c Release -o ./publish
          elif [ "${{ matrix.project }}" == "dash" ]; then
            dotnet publish FabrikamDashboard/FabrikamDashboard.csproj -c Release -o ./publish
          fi
      
      - name: Upload artifact for ${{ matrix.project }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-build
          path: ./publish
          retention-days: 1
  
  # Deploy to Team-24
  deploy:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        project: [api, mcp, sim, dash]
    
    steps:
      - name: Download ${{ matrix.project }} artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.project }}-build
          path: ./publish
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Discover app name for ${{ matrix.project }}
        id: discover-app
        run: |
          # Map project to app name pattern
          if [ "${{ matrix.project }}" == "api" ]; then
            PATTERN="fabrikam-api-dev-"
          elif [ "${{ matrix.project }}" == "mcp" ]; then
            PATTERN="fabrikam-mcp-dev-"
          elif [ "${{ matrix.project }}" == "sim" ]; then
            PATTERN="fabrikam-sim-dev-"
          elif [ "${{ matrix.project }}" == "dash" ]; then
            PATTERN="fabrikam-dash-dev-"
          fi
          
          # Find app with matching pattern
          APP_NAME=$(az webapp list -g ${{ env.RESOURCE_GROUP }} --query "[?starts_with(name, '$PATTERN')].name" -o tsv)
          
          if [ -z "$APP_NAME" ]; then
            echo "Error: No ${{ matrix.project }} app found in ${{ env.RESOURCE_GROUP }}"
            exit 1
          fi
          
          echo "app-name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "Found app: $APP_NAME"
      
      - name: Deploy ${{ matrix.project }} to Team-24
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ steps.discover-app.outputs.app-name }}
          package: ./publish
      
      - name: Configure dashboard app settings
        if: matrix.project == 'dash'
        run: |
          # Get API and Simulator URLs
          API_APP=$(az webapp list -g ${{ env.RESOURCE_GROUP }} --query "[?contains(name, 'api')].defaultHostName" -o tsv | head -n1)
          SIM_APP=$(az webapp list -g ${{ env.RESOURCE_GROUP }} --query "[?contains(name, 'sim')].defaultHostName" -o tsv | head -n1)
          
          # Configure app settings
          az webapp config appsettings set \
            -n ${{ steps.discover-app.outputs.app-name }} \
            -g ${{ env.RESOURCE_GROUP }} \
            --settings \
              "FabrikamApi__BaseUrl=https://$API_APP" \
              "FabrikamSimulator__BaseUrl=https://$SIM_APP" \
              "Authentication__Mode=Disabled" \
              "Dashboard__ServiceGuid=00000000-0000-0000-0000-000000000001"
          
          echo "✓ Dashboard configured with API: https://$API_APP"
          echo "✓ Dashboard configured with Simulator: https://$SIM_APP"
      
      - name: Verify deployment
        run: |
          echo "✓ Deployed: ${{ steps.discover-app.outputs.app-name }}"
          APP_URL=$(az webapp show -g ${{ env.RESOURCE_GROUP }} -n ${{ steps.discover-app.outputs.app-name }} --query defaultHostName -o tsv)
          echo "URL: https://$APP_URL"
      
      - name: Post-deployment health check
        run: |
          # Wait for app to warm up
          sleep 30
          
          # Get app URL
          APP_URL=$(az webapp show -g ${{ env.RESOURCE_GROUP }} -n ${{ steps.discover-app.outputs.app-name }} --query defaultHostName -o tsv)
          
          # Health check based on project type
          if [ "${{ matrix.project }}" == "api" ]; then
            URL="https://$APP_URL/health"
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
            if [ "$RESPONSE" == "200" ]; then
              echo "✓ API health check passed (HTTP 200)"
            else
              echo "⚠️ API health check returned HTTP $RESPONSE"
              exit 1
            fi
          elif [ "${{ matrix.project }}" == "mcp" ]; then
            URL="https://$APP_URL/status"
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
            if [ "$RESPONSE" == "200" ]; then
              echo "✓ MCP health check passed (HTTP 200)"
            else
              echo "⚠️ MCP health check returned HTTP $RESPONSE"
              exit 1
            fi
          elif [ "${{ matrix.project }}" == "sim" ]; then
            URL="https://$APP_URL/api/simulator/status"
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
            if [ "$RESPONSE" == "200" ]; then
              echo "✓ Simulator health check passed (HTTP 200)"
            else
              echo "⚠️ Simulator health check returned HTTP $RESPONSE"
              exit 1
            fi
          elif [ "${{ matrix.project }}" == "dash" ]; then
            URL="https://$APP_URL/"
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
            if [ "$RESPONSE" == "200" ]; then
              echo "✓ Dashboard health check passed (HTTP 200)"
            else
              echo "⚠️ Dashboard health check returned HTTP $RESPONSE"
              # Don't fail on dashboard - it may need authentication
            fi
          fi
